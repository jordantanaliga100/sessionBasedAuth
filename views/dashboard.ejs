<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 250px;
      }
    </style>
  </head>

  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Welcome to the Dashboard!</h1>

      <% if (user) { %>
      <div class="card shadow-sm p-4 mb-4">
        <h2>Hello, <%= user.username || user.email %> ðŸ‘‹</h2>
        <p><strong>User ID:</strong> <%= user.id %></p>
        <p><strong>Email:</strong> <%= user.email %></p>
      </div>
      <% } else { %>
      <div class="alert alert-warning">You are not logged in.</div>
      <% } %>

      <button id="logout-btn" class="btn btn-danger">Logout</button>
    </div>

    <!-- âœ… Toast container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <script>
      // ðŸ”¹ Toast utility
      function showToast(message, type = "info") {
        const container = document.querySelector(".toast-container");
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-bg-${type} border-0 show`;
        toast.role = "alert";
        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        `;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // ðŸ”¹ Check session on page load
      async function checkSession() {
        try {
          const res = await fetch("/api/v1/auth/me", {
            credentials: "include",
          });
          if (res.status === 401) {
            showToast("Session expired, redirecting to login...", "warning");
            setTimeout(() => (window.location.href = "/login"), 1500);
          }
        } catch (error) {
          showToast("Connection error, please refresh.", "danger");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        checkSession(); // initial check
        // ðŸ”¹ check every 30 seconds (not 1.5s!)
        setInterval(checkSession, 30000);
      });

      // ðŸ”¹ Logout handler
      document
        .getElementById("logout-btn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            const res = await fetch("/api/v1/auth/logout", {
              method: "GET",
              credentials: "include",
            });
            if (res.ok) {
              showToast("Logged out successfully!", "success");
              setTimeout(() => (window.location.href = "/login"), 1000);
            } else {
              showToast("Logout failed. Try again.", "danger");
            }
          } catch {
            showToast("Logout request failed.", "danger");
          }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
